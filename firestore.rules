rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // ユーザー認証が必要
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // リクエストしているユーザーがデータの所有者かチェック
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // 日記エントリー（diaries）
    match /diaries/{diaryId} {
      // 読み取り：自分のデータのみ
      allow read: if isOwner(resource.data.userId);
      // 作成：自分のuserIdで作成する必要がある
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      // 更新：自分のデータのみ
      allow update: if isOwner(resource.data.userId) && request.resource.data.userId == request.auth.uid;
      // 削除：自分のデータのみ
      allow delete: if isOwner(resource.data.userId);
    }
    
    // ユーザー設定（userSettings）
    match /userSettings/{userId} {
      // 読み取り：自分の設定のみ
      allow read: if isOwner(userId);
      // 作成：自分のuserIdで作成する必要がある
      allow create: if isAuthenticated() && userId == request.auth.uid;
      // 更新：自分の設定のみ
      allow update: if isOwner(userId);
      // 削除：自分の設定のみ
      allow delete: if isOwner(userId);
    }
    
    // 売上エントリー（sales）
    match /sales/{salesId} {
      // 読み取り：自分のデータのみ
      allow read: if isOwner(resource.data.userId);
      // 作成：自分のuserIdで作成する必要がある
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      // 更新：自分のデータのみ
      allow update: if isOwner(resource.data.userId) && request.resource.data.userId == request.auth.uid;
      // 削除：自分のデータのみ
      allow delete: if isOwner(resource.data.userId);
    }
    
    // 出勤日エントリー（attendance）
    match /attendance/{attendanceId} {
      // 読み取り：自分のデータのみ
      allow read: if isOwner(resource.data.userId);
      // 作成：自分のuserIdで作成する必要がある
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      // 更新：自分のデータのみ
      allow update: if isOwner(resource.data.userId) && request.resource.data.userId == request.auth.uid;
      // 削除：自分のデータのみ
      allow delete: if isOwner(resource.data.userId);
    }
    
    // その他のドキュメントは全て拒否
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

